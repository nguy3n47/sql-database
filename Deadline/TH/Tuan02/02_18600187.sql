--B1: TẠO CSDL
USE master
GO
IF DB_ID('QLSV') IS NOT NULL
	DROP DATABASE QLSV
GO
CREATE DATABASE QLSV
GO
USE QLSV
GO
--B2: TẠO BẢNG & KHÓA CHÍNH
CREATE TABLE SINHVIEN
(
	MASV INT, 
	HOTEN NVARCHAR(30),
	PHAI NVARCHAR(6),
	NGAYSINH DATE,
	DIACHI NVARCHAR(90),
	MANGANH VARCHAR(10)

	CONSTRAINT PK_SINHVIEN
	PRIMARY KEY(MASV)
)

CREATE TABLE NGANH
(
	MANGANH VARCHAR(10), 
	TENNGANH NVARCHAR(50),
	SOCD INT,
	TSSV INT,

	CONSTRAINT PK_NGANH
	PRIMARY KEY(MANGANH)
)

CREATE TABLE CHUYENDE
(
	MACD VARCHAR(10), 
	TENCHUYENDE NVARCHAR(50),
	SOSVTD INT

	CONSTRAINT PK_CHUYENDE
	PRIMARY KEY(MACD)
)

CREATE TABLE CD_NGANH
(
	MACD VARCHAR(10),
	MANGANH VARCHAR(10)

	CONSTRAINT PK_CD_NGANH
	PRIMARY KEY(MACD, MANGANH)
)

CREATE TABLE CD_MO
(
	MACD VARCHAR(10),
	HOCKY INT,
	NAM INT,

	CONSTRAINT PK_CD_MO
	PRIMARY KEY(MACD, HOCKY, NAM)
)

CREATE TABLE DANGKY
(
	MASV INT,
	MACD VARCHAR(10),
	HOCKY INT,
	NAM INT,
	DIEM FLOAT

	CONSTRAINT PK_DANGKY
	PRIMARY KEY(MASV, MACD, HOCKY, NAM)
)

--B3: TẠO KHÓA NGOẠI
ALTER TABLE SINHVIEN
ADD
	CONSTRAINT FK_SV_NGANH
	FOREIGN KEY (MANGANH)
	REFERENCES NGANH

ALTER TABLE CD_NGANH
ADD
	CONSTRAINT FK_CDNGANH_NGANH
	FOREIGN KEY (MANGANH)
	REFERENCES NGANH,
	CONSTRAINT FK_CDNGANH_CHUYENDE
	FOREIGN KEY (MACD)
	REFERENCES CHUYENDE

ALTER TABLE CD_MO
ADD
	CONSTRAINT FK_CDMO_CHUYENDE
	FOREIGN KEY (MACD)
	REFERENCES CHUYENDE

ALTER TABLE DANGKY
ADD
	CONSTRAINT FK_DK_SV
	FOREIGN KEY (MASV)
	REFERENCES SINHVIEN,
	CONSTRAINT FK_DK_CDMO
	FOREIGN KEY (MACD, HOCKY, NAM)
	REFERENCES CD_MO

--B4: TẠO RÀNG BUỘC GIÁ TRỊ --> CHECK
ALTER TABLE SINHVIEN
ADD
	CONSTRAINT CK_PHAI_SV
	CHECK (PHAI = 'NAM' OR PHAI = N'NỮ')

ALTER TABLE NGANH
ADD
	CONSTRAINT CK_SOCD_NGANH
	CHECK (SOCD <= 5)

--B5: TẠO RÀNG BUỘC DUY NHẤT --> UNIQUE
ALTER TABLE SINHVIEN
ADD
	CONSTRAINT U_MASV_SV
	UNIQUE(MASV)

ALTER TABLE NGANH
ADD
	CONSTRAINT U_MA_NGANH
	UNIQUE(MANGANH),
	CONSTRAINT U_TEN_NGANH
	UNIQUE(TENNGANH)

ALTER TABLE CHUYENDE
ADD
	CONSTRAINT U_MA_CD
	UNIQUE (MACD),
	CONSTRAINT UK_TEN_CD
	UNIQUE (TENCHUYENDE)
GO
-- NHẬP LIỆU
INSERT NGANH (MANGANH, TENNGANH, SOCD, TSSV)
VALUES 
('CNTT', N'Công nghệ thông tin', 4, 500),
('HTTT', N'Hệ thống thông tin', 5, 400),
('ATTT', N'An toàn thông tin', 5, 450),
('KTPM', N'Kỹ thuật phần mềm', 5, 550),
('KTMT', N'Kỹ thuật máy tính', 4, 450),
('MMT' , N'Mạng máy tính và truyền thông dữ liệu', 4, 400),
('KHMT', N'Khoa học máy tính', 3, 300),
('KHDL', N'Khoa học dữ liệu', 3, 450),
('TMDT', N'Thương mại điện tử', 4, 300),
('TGMT', N'Thị giác máy tính', 3, 400)

INSERT CHUYENDE (MACD, TENCHUYENDE, SOSVTD)
VALUES
('001', N'Cơ sở hạ tầng Công nghệ thông tin', 100),
('002', N'Xây dựng HTTT trên các framework', 90),
('003', N'Kỹ thuật phân tích mã độc', 120),
('004', N'Lập trình trên thiết bị di động', 150),
('005', N'Xử lý tín hiệu số và ứng dụng', 110),
('006', N'Quản trị mạng và hệ thống', 90),
('007', N'Trí tuệ nhân tạo', 100),
('008', N'Khai phá dữ liệu', 80),
('009', N'Hệ quản trị cơ sở dữ liệu', 90),
('010', N'Xử lý ảnh kỹ thuật số', 100)

INSERT SINHVIEN (MASV, HOTEN, PHAI, NGAYSINH, DIACHI, MANGANH)
VALUES
('001', N'Phạm Hương', N'Nữ', '1/24/2000', N'44 Lý Thường Kiệt, Hà Nội',  'TMDT'),
('002', N'Nguyễn Nam', 'Nam', '2/14/1999', N'147 Hai Bà Trưng, Q3, TPHCM', 'TGMT'),
('003', N'Nhật Minh', 'Nam', '3/16/1999', N'23 Hai Bà Trưng, Hà Nội', 'KHDL'),
('004', N'Anh Thư', N'Nữ', '4/7/2000', N'28 Tôn Thất Tùng, Q1, TPHCM', 'KHMT'),
('005', N'Ngọc Ánh', N'Nữ', '5/18/2001', N'83 Ba Đình, Hà Nội', 'MMT'),
('006', N'Anh Duy', 'Nam', '6/1/2001', N'76 Lê Lai, Q1, TPHCM', 'KTMT'),
('007', N'Bảo Hân', N'Nữ', '7/4/1999', N'19 Chả Cá, Hà Nội', 'KTPM'),
('008', N'Hoàng Khoa', 'Nam', '8/8/2000', N'15 Phạm Ngũ Lão, Q1, TPHCM', 'ATTT'),
('009', N'Thanh Nga', N'Nữ', '9/29/1999', N'198 Nguyễn Thị Minh Khai, Q3, TPHCM', 'HTTT'),
('010', N'Đức Huy', 'Nam', '10/7/2000', N'74 Tự Cường, TPHCM', 'CNTT')

INSERT CD_NGANH (MACD, MANGANH)
VALUES
('001', 'CNTT'),
('002', 'HTTT'),
('003', 'ATTT'),
('004', 'KTPM'),
('005', 'KTMT'),
('006',  'MMT'),
('007', 'KHMT'),
('008', 'KHDL'),
('009', 'TMDT'),
('010', 'TGMT')

INSERT CD_MO (MACD, HOCKY, NAM)
VALUES
('001', 1, 2017),
('002', 1, 2019),
('003', 2, 2020),
('004', 1, 2019),
('005', 2, 2018),
('006', 2, 2019),
('007', 2, 2018),
('008', 1, 2020),
('009', 2, 2019),
('010', 1, 2018)

INSERT DANGKY (MASV, MACD, HOCKY, NAM, DIEM)
VALUES
('001', '009', 2, 2019, 8.2),
('002', '010', 1, 2018, 7.8),
('003', '008', 1, 2020, 8.0),
('004', '007', 2, 2018, 7.4),
('005', '006', 2, 2019, 8.5),
('006', '005', 2, 2018, 9.3),
('007', '004', 1, 2019, 6.8),
('008', '003', 2, 2020, 7.0),
('009', '002', 1, 2019, 9.0),
('010', '001', 1, 2017, 8.8)

-- TRUY VẤN
-- CÂU 1
SELECT SV.HOTEN
FROM SINHVIEN SV
WHERE SV.MANGANH = 'HTTT' AND SV.PHAI = N'NỮ'

-- CÂU 2
SELECT CM.MACD, CM.HOCKY
FROM CD_MO CM
WHERE CM.NAM >= 2003 AND CM.NAM <= 2017

-- CÂU 3
SELECT SV.*
FROM SINHVIEN SV
WHERE SV.DIACHI LIKE N'% TPHCM'

-- CÂU 4
SELECT SV.HOTEN, DATEDIFF (YY, SV.NGAYSINH, GETDATE()) TUOI, SV.MANGANH
FROM SINHVIEN SV
WHERE SV.PHAI = N'NỮ' AND ( YEAR(SV.NGAYSINH) > 2000 OR SV.DIACHI LIKE N'% HÀ NỘI')

-- CÂU 5
SELECT NH.TENNGANH
FROM NGANH NH
WHERE NH.TSSV > 100 AND NH.SOCD > 10
